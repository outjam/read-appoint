# Механизм проверки и обновления версии мобильного приложения

## Цель
Реализовать механизм принудительной и рекомендательной проверки версии мобильного приложения с централизованным управлением через **административную панель:**
- Контроль доступности версий
- Управление обязательными и необязательными обновлениями
- Перенаправление пользователя в нужный магазин приложений
- Поддержка миграции приложения в аккаунт другого разработчика

---

## Поддерживаемые платформы и магазины

### Android
| Источник установки    | Описание                       |
| --------------------- | ------------------------------ |
| **Google Play**       | Официальный маркет Google      |
| **RuStore**           | Российский официальный магазин |
| **APK (Yandex Disk)** | Прямая установка через APK     |

### iOS
| Источник установки | Описание                  |
| ------------------ | ------------------------- |
| **App Store**      | Официальный магазин Apple |
| **TestFlight**     | Тестовые сборки           |

> ❗ Пользователь должен быть перенаправлен строго в тот стор, из которого приложение было установлено.

---

## Общая логика проверки версии

### Момент проверки

#### Проверка версии выполняется:
- При запуске приложения
- При возврате приложения из background

#### Запрос на сервер
**Endpoint:**
> **GET** /api/v1/mobile/app-version/check

**Параметры запроса:**
{
  "platform": "android | ios",
  "currentVersion": "string",
  "buildNumber": "integer",
  "installSource": "google_play | rustore | yandex_apk | appstore | testflight"
}

---

## Типы состояний версии

### Актуальная версия

#### Условие:
Версия пользователя ≥ минимальной стабильной версии

#### Поведение:
- Приложение работает в обычном режиме
- Никаких уведомлений не показывается

#### Сценарии пользователя
1. Запускает приложение
2. Выполняется запрос на сервер
3. Получает статус **UP_TO_DATE**
4. Использует приложение без ограничений

---

### Доступно необязательное обновление *(можно отложить)*

#### Условие:
Версия входит в диапазон устаревающих версий

#### Поведение:
Показывается модальное окно:

#### Текст:
> Доступна новая версия приложения. Рекомендуем обновить для стабильной работы.

#### Кнопки:
- **Обновить** → открывает соответствующий Store
- **Позже** → закрывает окно и позволяет пользоваться приложением

#### Частота повтора показа:
- 1 раз в N запусков (задаётся в админ-панели)

#### Сценарии пользователя
1. Запускает приложение
2. Выполняется запрос на сервер
3. Получает статус **OPTIONAL_UPDATE**
4. Появляется модальное окно
5. Варианты:
   1. Нажимает **Обновить** → открывается Store
   2. Нажимает **Позже** → продолжает работу

---

### Обязательное обновление *(блокирующее)*

#### Условие:
Версия ниже минимально допустимой для работы

#### Поведение:
Показывается полноэкранный блокирующий экран:

#### Текст:
> Для продолжения работы необходимо обновить приложение.

#### Кнопки:
- **Обновить** → ведёт в Store
- Кнопка "Закрыть" отсутствует

#### Частота повтора показа:
> Пользователь не может использовать приложение пока не обновит его.

#### Сценарии пользователя
1. Запускает приложение
2. Выполняется запрос на сервер
3. Получает статус **FORCE_UPDATE**
4. Отображается блокирующий экран
5. Варианты:
   1. Нажимает **Обновить** → открывается Store
   2. Пользователь не может пользоваться приложением

---

#### Условие:
Версия ниже deprecatedVersion и приложение находится под старым пакетом/аккаунтом разработчика.

#### Поведение:
Перенаправить пользователя в новое приложение в Store аккаунте другого разработчика.

#### Текст:
> Приложение было обновлено и перенесено. Пожалуйста, установите новую версию приложения из магазина.

#### Кнопки:
- **Перейти в магазин** → ведёт на новую страницу приложения

#### Частота повтора показа:
> Пользователь не может использовать приложение пока не обновит его.

#### Сценарии пользователя
1. Запускает приложение
2. Выполняется запрос на сервер
3. Получает статус **MIGRATION_REQUIRED**
4. Отображается блокирующий экран
5. Варианты:
   1. Нажимает **Установить новое приложение** → открывается Store
   2. Пользователь не может пользоваться приложением

---

## Определение источника установки приложения

### Android
**Определяется программно через:**
- Google Play Installer
- RuStore Installer
- Package Manager
- Маркеры APK сборки

В запрос передаётся поле:
> "installSource": "google_play | rustore | yandex_apk"

### iOS
**Определение:**
- App Store → production build
- TestFlight → sandbox build

В запрос передаётся поле:
> "installSource": "appstore | testflight"

---

## Ответ сервера
{
  "status": "UP_TO_DATE | OPTIONAL_UPDATE | FORCE_UPDATE | MIGRATION_REQUIRED",
  "minVersion": "1.2.0",
  "latestVersion": "2.0.0",
  "storeUrl": "https://...",
  "message": "string"
}

## Административная панель — управление версиями

### Основные функции
**Админ-панель должна позволять:**
- Управлять статусами версий
- Устанавливать минимально допустимую версию
- Определять обязательность обновления
- Управлять ссылками на магазины
- Управлять логикой миграции на новый аккаунт

---

### Структура настроек версий
| Поле                  | Описание                                |
| --------------------- | --------------------------------------- |
| `platform`            | android / ios                           |
| `minSupportedVersion` | Минимальная рабочая версия              |
| `latestVersion`       | Последняя доступная версия              |
| `forceUpdateBelow`    | Версии ниже — блокируются               |
| `optionalUpdateBelow` | Версии ниже — показывается рекомендация |
| `deprecatedBelow`     | Версия, ниже которой работает миграция  |
| `migrationEnabled`    | Вкл/выкл миграции                       |

---

### Управление ссылками на Store
**Отдельный таб админки: “Store Links”**

| Поле                | Описание                                                   |
| ------------------- | ---------------------------------------------------------- |
| `platform`          | android / ios                                              |
| `installSource`     | google_play / rustore / yandex_apk / appstore / testflight |
| `storeUrl`          | ссылка на страницу приложения                              |
| `migrationStoreUrl` | ссылка на новое приложение                                 |

---

### Частота показа необязательного обновления

**Настраиваемые параметры:**
- optionalUpdateShowEveryLaunch (bool)
- optionalUpdateRepeatAfterDays
- optionalUpdateRepeatAfterSessions